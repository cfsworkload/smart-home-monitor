---
stages:
- name: build
  inputs:
  - type: git
    branch: master
  triggers:
  - type: commit
  jobs:
  - name: Build
    type: builder
    artifact_dir: ''
- name: deploy front-end
  inputs:
  - type: job
    stage: build
    job: Build
  triggers:
  - type: stage
  jobs:
  - name: Deploy
    type: deployer
    target:
      url: ${CF_TARGET_URL}
      organization: ${CF_ORGANIZATION}
      space: ${CF_SPACE}
      application: ${CF_APP}
    script: "#!/bin/bash\n\ncd front-end\nhostname=\"${CF_APP}.mybluemix.net\"\ncf\
      \ create-service cloudantNoSQLDB Shared \"${CF_APP}-cloudant\"\ncf create-service\
      \ iotf-service iotf-service-free \"${CF_APP}-iotf-service\"\ncf push \"${CF_APP}-front-end\"\
      \ -n \"${CF_APP}-front-end\" --no-start\ncf set-env \"${CF_APP}-front-end\"\
      \ HOSTNAME $hostname\ncf bind-service \"${CF_APP}-front-end\" \"${CF_APP}-cloudant\"\
      \ \ncf bind-service \"${CF_APP}-front-end\" \"${CF_APP}-iotf-service\"\ncf start\
      \ \"${CF_APP}-front-end\""
- name: deploy back-end
  inputs:
  - type: job
    stage: build
    job: Build
  jobs:
  - name: deploy node-red
    type: deployer
    target:
      url: ${CF_TARGET_URL}
      organization: ${CF_ORGANIZATION}
      space: ${CF_SPACE}
      application: ${CF_APP}
    script: "#!/bin/bash   \n      cd back-end\n      cf create-service cloudantNoSQLDB\
      \ Shared \"${CF_APP}-cloudant\"\n      cf create-service dashDB Entry \"${CF_APP}-dashDB\"\
      \n      cf create-service erservice free \"${CF_APP}-erservice\"\n      cf create-service\
      \ \"IoT Real-Time Insight\" Lite \"${CF_APP}-insights\"\n      # create message\
      \ source in insight service \n      echo \"Sending rest request\"\n      cf\
      \ push \"${CF_APP}-back-end\" -n \"${CF_APP}-back-end\" --no-start\n      cf\
      \ bind-service \"${CF_APP}-back-end\" \"${CF_APP}-cloudant\"\n      cf bind-service\
      \ \"${CF_APP}-back-end\" \"${CF_APP}-dashDB\"\n      cf bind-service \"${CF_APP}-back-end\"\
      \ \"${CF_APP}-erservice\"\n      cf bind-service \"${CF_APP}-back-end\" \"${CF_APP}-iotf-service\"\
      \n      cf bind-service \"${CF_APP}-back-end\" \"${CF_APP}-insights\"\n    \
      \  cf start \"${CF_APP}-back-end\""